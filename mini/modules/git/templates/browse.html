{% extends "_repository_base.html" %}

{% block repository_content %}

<div class="callout callout-info commit-message">
    <div class="info pull-right">
        {% for c in [commit]+commit.parents|list %}
            <div>
                {{ "commit" if c == commit else "parent" }}
                <a class="sha" href="{{ url_for('git.commit', slug=repository.slug, rev=c.hexsha) }}">{{ c.hexsha | shortsha }}</a>
            </div>
        {% endfor %}
    </div>

    <h4>{{ commit.message|first_line }}</h4>
    {% set message_body = (commit.message|splitlines)[1:] %}
    {% if message_body %}<pre>{{ "\n".join(message_body) }}</pre>{% endif %}

    <div class="meta">
        Authored by {{ (commit.author|git_user).get_link() }}
        on {{ commit|git_committer_time|date_human }}
    </div>
</div>

<h4>
    {% set isbranch = (rev in repository.git.branches) %}

    <span class="branch-select">
    <span class="input-group">
        <span class="input-group-addon input-small">{% if isbranch %}branch{% else %}commit{% endif %}</span>

        <select class="form-control input-small" id="branch-select">
            {% for branch in repository.git.branches %}
                <option value="{{ url_for('git.browse', slug=repository.slug, rev=branch, path=path) }}" {% if branch.commit == commit %}selected="SELECTED"{% endif %}>{{ branch.name }}</option>
            {% endfor %}

            {% if not isbranch %}
                <option value="{{ url_for('git.browse', slug=repository.slug, rev=rev, path=path) }}" selected="SELECTED">{{ rev[:10] }}</option>
            {% endif %}
        </select>
    </span>
    </span>

    {% include "_path.html" %}
</h4>

<table class="table table-bordered table-striped tree-table">
    <thead>
        <tr>
            <th width="16"></th>
            <th>Filename</th>
            <th>Size</th>
            <th>Last changed</th>
            <th>Commit</th>
            <th>Message</th>
        </tr>
    </thead>
    <tbody>
    {% if path %}
    <tr class="folder">
        <td><i class="fam-16 fam-folder"></i></td>
        <td><a href="{{ url_for('git.browse', slug=repository.slug, rev=rev, path=path | parentpath) }}">[..]</a></td>
        <td></td>
        <td></td>
        <td></td>
        <td class="text-muted">- parent directory -</td>
    </tr>
    {% endif %}

{% if tree.trees or tree.blobs %}
{% for file in tree.trees + tree.blobs %}
    {% set last = commit %} {# repository.findCommitContaining(rev, file) #}
    <tr class="{% if file.type == "TREE" %}folder{% else %}file{% endif %}">
        <td><i class="fam-16 fam-{{ file | filetype }}"></i></td>
        <td><a href="{{ url_for('git.browse', slug=repository.slug, rev=rev, path=file.path) }}">{{ file.name }}</a></td>
        <td>{% if file.type == "BLOB" %}{{ file.size | filesize }}{% else %}&mdash;{% endif %}</td>
        <td>{{ last | git_committer_time | datetime }}</td>
        <td><a href="{{ url_for('git.commit', slug=repository.slug, rev=last.hexsha) }}" class="sha">{{ last.hexsha|shortsha }}</a></td>
        <td>{{ last.message[:70] }}</td>
    </tr>
{% endfor %}
{% else %}
    <tr><td colspan="5"><i>This directory is empty.</i></td></tr>
{% endif %}
    </tbody>
</table>

{# SHOW README IF ANY #}
{% set file = tree|find_readme %}
{% if file %}
    {% include "render_file.html" %}
{% elif path == "" %}
    <p>You should add a readme file.</p>
{% endif %}

{% endblock %}
