{% extends "_commit_base.html" %}

{% block commit_content %}

{% set author = commit.author | git_user %}
{% set date = commit | git_committer_time %}

<p>
    <span class="stats">
        {% set s = commit.stats.total %}
        <span class="insertions">{{ s["insertions"] }} insertions</span>
        -
        <span class="deletions">{{ s["deletions"] }} deletions</span>
        -
        <span class="lines">{{ s["lines"] }} total</span>
    </span>

    <span class="pull-right">
        <a href="{{ url_for('git.browse', slug=repository.slug, rev=rev) }}" class="btn btn-primary btn-small">Browse files @ {{ commit.hexsha|shortsha }}</a>
    </span>
    <div style="clear: right;"></div>
</p>


{% if not commit.parents[0] %}
    <p class="alert alert-info">
        This commit does not have any parents, just <a href="{{ url_for('git.browse', slug=repository.slug, rev=commit.hexsha) }}">browse its code</a> if you want to see the file contents.
    </p>
{% elif commit.parents[1] %}
    <p class="alert alert-info">
        This commit is a merge commit. See the parent's diffs for details.
    </p>
{% else %}
    {% for diff in commit.parents[0].diff(commit, create_patch = True) %}
        <div class="commit-file panel">
            {% set from = diff.rename_from if diff.renamed else diff.a_blob.path %}
            {% set to = diff.rename_to if diff.renamed else diff.b_blob.path %}

            {% set lines = diff.diff.splitlines() %}

            <div class="panel-heading files">
                <span class="from">{{ from }}</span>
                {% if to != from %}
                    <span class="rename">&raquo;</span>
                    <span class="to">{{ to }}</span>
                {% endif %}
            </div>

            <div class="diff">
                <table class="patch">
                {% set lineA, lineB = 0, 0 %}

                {% for line in lines[2:] %}
                    {% set t = line | diffLineType %}

                    {% if t == "section" %}
                        {% set lineA, lineB = line | diffParseSection %}
                    {% endif %}

                    {% if t != "insertion" %}{% set lineA = lineA + 1 %}{% endif %}
                    {% if t != "deletion" %}{% set lineB = lineB + 1 %}{% endif %}

                    <tr class="line {{ t }}">
                        {% if t == "section" %}
                            <td colspan="nonumber"></td>
                            <td colspan="nonumber"></td>
                        {% else %}
                            <td class="number a">{% if t != "insertion" %}{{ lineA }}{% endif %}</td>
                            <td class="number b">{% if t != "deletion" %}{{ lineB }}{% endif %}</td>
                        {% endif %}
                        <td> {{ line }}</td>
                    </tr>
                {% endfor %}

                {% if lines | length <= 2 %}
                    <tr class="line context"><td colspan="3">[no changes]</td></div>
                {% endif %}
                </table>
            </div>

            <div class="panel-footer stats">
                {% set s = commit.stats.files[to] %}
                <span class="insertions">{{ s["insertions"] }} insertions</span>
                -
                <span class="deletions">{{ s["deletions"] }} deletions</span>
                -
                <span class="lines">{{ s["lines"] }} total</span>

                <div class="pull-right">
                    <a href="{{ url_for('git.browse', slug=repository.slug, rev=commit.hexsha, path=diff.b_blob.path) }}">Show file @ {{ commit.hexsha|shortsha }}</a>
                </div>
            </div>
        </div>
    {% endfor %}
{% endif %}

{% endblock %}

